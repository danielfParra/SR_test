{% extends "otree/Page.html" %}

{% block title %}
    Decoding Task
{% endblock %}

{% block content %}

<div class="card bg-light border-dark mb-3">
    <div class="card-body">
        <h5 id="task-title">Decoding Task {{ task_number }} of {{ total_tasks }}</h5>
        <hr>
        <div class="alert alert-warning text-center" role="alert">
    ⏳ Time left: <span id="timer">{{ time_per_task }}</span> seconds
        </div>
        <p>Decode the following message:</p>
        <div class="card bg-white mb-3">
            <div class="card-body">
                <h4 class="text-center"><b id="encoding">{{ encoding }}</b></h4>
            </div>
        </div>

        <!-- Hidden field to store correct answers and update dynamically -->
        <input type="hidden" name="correct_answers" id="correct_answers" value="{{ correct_answers }}">

        <div class="form-group">
            <label for="decoding_answer">Your answer:</label>
            <input type="number" id="decoding_answer" name="decoding_answer" class="form-control" required>
        </div>

        <div class="mt-3">
            <button id="submit-button" type="button" class="btn btn-primary">Submit</button>
        </div>

        <div class="alert alert-danger mt-3" id="warning-message" style="display: none;">
            Incorrect answer. Please wait 5 seconds before trying again.
        </div>


    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let tasks = {{ tasks_json | safe }};
    let currentTaskIndex = {{ task_number }} - 1;
    let timeLeft = {{ time_per_task }};
    let timer;

    $(window).bind('beforeunload', function() {
    if (currentTaskIndex < tasks.length - 1) {  // Show the warning only if it's not the last task
        return "'Are you sure you want to leave the page? All data will be lost!";
    }
});

    document.addEventListener("DOMContentLoaded", function() {
        startTask();

        // Allow "Enter" key to submit the answer instead of leaving the page
    document.getElementById("decoding_answer").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();  // Prevent page reload or unintended form submission
        document.getElementById("submit-button").click();  // Trigger the submit button click
    }
});


        document.getElementById("submit-button").addEventListener("click", function() {
            let playerAnswer = document.getElementById("decoding_answer").value;
            let correctAnswer = tasks[currentTaskIndex]['answer'];

            if (playerAnswer == correctAnswer) {
                updateCorrectAnswers();
                showNextTask();
            } else {
                showWarning();
            }
        });
    });

    function startTask() {
        clearInterval(timer);
        startTimer();
    }

    function startTimer() {
        let timerElement = document.getElementById("timer");
        timeLeft = {{ time_per_task }};
        timerElement.innerText = timeLeft;

        timer = setInterval(function() {
            timeLeft--;
            timerElement.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timer);
                showNextTask();  // Auto-submit when time runs out
            }
        }, 1000);
    }

    function updateCorrectAnswers() {
        let correctAnswersField = document.getElementById("correct_answers");
        let currentCorrect = Number(correctAnswersField.value);
        correctAnswersField.value = currentCorrect + 1;
    }

    function showWarning() {
        let warningMessage = document.getElementById("warning-message");
        let submitButton = document.getElementById("submit-button");
        let answerInput = document.getElementById("decoding_answer");

        warningMessage.style.display = "block";
        submitButton.disabled = true;
        answerInput.disabled = true;

        setTimeout(function() {
            warningMessage.style.display = "none";
            submitButton.disabled = false;
            answerInput.disabled = false;
            answerInput.value = "";
        }, 5000);
    }

    function showNextTask() {
        currentTaskIndex++;
        if (currentTaskIndex >= tasks.length) {
            submitForm();  // Submit the form if it’s the last task
        } else {
            updateTaskContent();
        }
    }

    function updateTaskContent() {
        document.getElementById("task-title").innerText = `Decoding Task ${currentTaskIndex + 1} of {{ total_tasks }}`;
        document.getElementById("encoding").innerHTML = tasks[currentTaskIndex]['encoding'];
        document.getElementById("decoding_answer").value = "";
        startTask();
    }

    function submitForm() {
        document.getElementById("correct_answers").dispatchEvent(new Event('change'));  // Ensure it's updated
        let form = document.querySelector("form");
        form.submit();
    }
</script>
{% endblock %}

{% block styles %}
<style>
    .card-body {
        text-align: center;
        font-size: 18px;
    }
    .form-control {
        max-width: 200px;
        margin: auto;
        text-align: center;
    }
    #warning-message {
        font-size: 16px;
    }
</style>
{% endblock %}
